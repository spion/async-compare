require('stratifiedjs');

__oni_rt.exseq(this.arguments,this,'examples/src-stratifiedjs-014.sjs',[24,__oni_rt.C(function(){return require('../lib/fakesSJS-dst.js')},1),__oni_rt.Nb(function(){return module.exports=function upload(stream,idOrPath,tag,done){var blob,blobId,file,previousId,version,tx,fileId,splitPath,fileName;return __oni_rt.exseq(arguments,this,'examples/src-stratifiedjs-014.sjs',[1,__oni_rt.Nb(function(){blob=blobManager.create(account);},5),__oni_rt.Sc(6,function(_oniX){return blobId=_oniX;},__oni_rt.C(function(){return blob.put(stream)},5)),__oni_rt.Sc(7,function(_oniX){return file=_oniX;},__oni_rt.Fcall(1,6,__oni_rt.Sc(6,function(l){return [l,'get'];},__oni_rt.C(function(){return self.byUuidOrPath(idOrPath)},6)))),__oni_rt.Nb(function(){previousId=file?file.version:null;version={userAccountId:userAccount.id,date:new Date(),blobId:blobId,creatorId:userAccount.id,previousId:previousId};version.id=Version.createHash(version);tx=db.begin();},0),__oni_rt.Try(0,__oni_rt.Seq(0,__oni_rt.Fcall(1,19,__oni_rt.Sc(19,function(l){return [l,'execWithin'];},__oni_rt.C(function(){return Version.insert(version)},19)),__oni_rt.Nb(function(){return tx},19)),__oni_rt.Nb(function(){if(! file)return __oni_rt.ex(__oni_rt.Nb(function(){splitPath=idOrPath.split('/');fileName=splitPath[splitPath.length - 1];fileId=uuid.v1();return self.createQuery(idOrPath,{id:fileId,userAccountId:userAccount.id,name:fileName,version:version.id}).execWithin(tx);},0),this);else return __oni_rt.ex(__oni_rt.Nb(function(){return fileId=file.id},36),this);},22),__oni_rt.Fcall(1,39,__oni_rt.Sc(39,function(l){return [l,'execWithin'];},__oni_rt.C(function(){return FileVersion.insert({fileId:fileId,versionId:version.id})},39)),__oni_rt.Nb(function(){return tx},39)),__oni_rt.Fcall(1,41,__oni_rt.Sc(41,function(l){return [l,'execWithin'];},__oni_rt.C(function(){return File.whereUpdate({id:fileId},{version:version.id})},41)),__oni_rt.Nb(function(){return tx},41))),function(__oni_env,e){return __oni_rt.ex(__oni_rt.Seq(0,__oni_rt.C(function(){return tx.rollback()},43),__oni_rt.Nb(function(){return done(e);},44)),__oni_env)},0),__oni_rt.C(function(){return tx.commit()},46),__oni_rt.Nb(function(){return done();},47)])};},49)])

